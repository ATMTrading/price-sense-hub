<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bestpric.eu</title>
  <meta name="description" content="Porovnávač cien tisícov produktov – nájdite najlepšie ponuky z desiatok obchodov na jednom mieste." />
  <link rel="icon" href="/favicon.ico">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --brand: #2563eb;
      --brand-soft: rgba(37, 99, 235, 0.12);
      --radius-lg: 28px;
      --radius-md: 18px;
      --gap: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font: 16px/1.5 "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.24);
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px var(--gap);
    }

    .brand {
      font-weight: 800;
      font-size: 24px;
      letter-spacing: -0.02em;
      color: var(--brand);
    }

    .search-bar {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .search-bar input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 999px;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    main {
      padding-bottom: 80px;
    }

    .hero {
      margin: 36px 0 28px;
      padding: 40px clamp(20px, 6vw, 48px);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(14, 116, 144, 0.08));
      color: var(--ink);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      display: grid;
      gap: 24px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(30px, 6vw, 44px);
      line-height: 1.08;
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      max-width: 620px;
      color: rgba(15, 23, 42, 0.78);
      font-size: 18px;
    }

    .hero-ctas {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 22px;
      border-radius: 999px;
      font-weight: 600;
      text-decoration: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .cta.primary {
      background: var(--brand);
      color: #fff;
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.3);
    }

    .cta.primary:hover {
      transform: translateY(-1px);
    }

    .cta.secondary {
      background: rgba(255, 255, 255, 0.85);
      color: var(--brand);
      border: 1px solid rgba(37, 99, 235, 0.25);
    }

    .hero-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--ink);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
    }

    .lane {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
      margin-bottom: 28px;
    }

    .lane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px clamp(16px, 4vw, 28px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.16);
    }

    .lane-header h2 {
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.01em;
    }

    .lane-grid {
      display: grid;
      gap: var(--gap);
      padding: clamp(16px, 4vw, 28px);
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .tile {
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148, 163, 184, 0.14);
      border-radius: var(--radius-md);
      background: var(--surface);
      text-decoration: none;
      color: inherit;
      overflow: hidden;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .tile:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
    }

    .thumb {
      aspect-ratio: 4 / 3;
      display: grid;
      place-items: center;
      background: rgba(37, 99, 235, 0.05);
    }

    .thumb img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .tile h3,
    .tile h4 {
      margin: 16px 18px 6px;
      font-size: 18px;
    }

    .muted {
      margin: 0 18px 18px;
      color: var(--muted);
      font-size: 14px;
    }

    .price {
      margin: 12px 18px 18px;
      font-weight: 700;
      font-size: 18px;
      color: var(--ink);
    }

    .crumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 18px;
    }

    .crumbs a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      padding: 0 clamp(16px, 4vw, 28px) 12px;
    }

    select {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: #fff;
      font: inherit;
    }

    .center {
      display: grid;
      place-items: center;
      padding: 48px;
      color: var(--muted);
      text-align: center;
    }

    footer {
      padding: 40px var(--gap);
      text-align: center;
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 720px) {
      .hero {
        padding: 32px 24px;
      }

      .lane-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="wrap search-bar">
      <div class="brand">bestpric.eu</div>
      <input id="search" type="search" placeholder="Hľadať produkty" autocomplete="off" />
    </div>
  </header>

  <main class="wrap" id="app"></main>

  <footer id="foot"></footer>

  <script>
    const SUPABASE_URL = 'https://xxplocdervsfftnnalah.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4cGxvY2RlcnZzZmZ0bm5hbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTIyODYsImV4cCI6MjA3MTQ2ODI4Nn0.Gh8AShwePYUuiJjj_G1qFuMaTRC_6HZOSERifIvjZro';
    const supa = supabase.createClient(SUPABASE_URL, ANON_KEY);

    const $ = (selector) => document.querySelector(selector);
    const app = $('#app');
    const searchInput = $('#search');
    const footerEl = $('#foot');

    const state = {
      ready: false,
      marketCode: 'SK',
      categories: [],
      categoryBySlug: new Map(),
      categoryById: new Map(),
      childrenByParent: new Map(),
    };

    function escapeHtml(value) {
      return (value || '').replace(/[&<>\"']/g, (character) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[character] || character));
    }

    function formatPrice(value, currency) {
      if (value == null) {
        return '';
      }

      try {
        return new Intl.NumberFormat('sk-SK', {
          style: 'currency',
          currency: currency || 'EUR',
          minimumFractionDigits: 0,
        }).format(value);
      } catch (error) {
        return `${value} ${currency || 'EUR'}`;
      }
    }

    function slugParts(path) {
      return (path || '')
        .split('|')
        .map((segment) => segment.trim())
        .filter(Boolean);
    }

    function buildSlugPath(parts) {
      return parts.filter(Boolean).join('|');
    }

    function updateRoute(params) {
      const url = new URL(window.location.href);
      Object.entries(params).forEach(([key, value]) => {
        if (value == null || value === '') {
          url.searchParams.delete(key);
        } else {
          url.searchParams.set(key, value);
        }
      });
      history.pushState({}, '', url);
      render();
    }

    window.addEventListener('popstate', render);

    searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const value = searchInput.value.trim();
        updateRoute({ search: value || null, c: null, shop: null, sort: null });
      }
    });

    function parseRoute() {
      const url = new URL(window.location.href);
      const slugPath = url.searchParams.get('c') || '';
      const search = url.searchParams.get('search') || '';
      const shop = url.searchParams.get('shop') || '';
      const sort = url.searchParams.get('sort') || 'price.asc';
      return { slugPath, search, shop, sort };
    }

    async function detectMarket() {
      try {
        const { data } = await supa
          .from('products')
          .select('market_code')
          .eq('is_active', true)
          .limit(1);

        if (data && data.length && data[0].market_code) {
          state.marketCode = String(data[0].market_code).toUpperCase();
          return;
        }
      } catch (error) {
        console.warn('Nepodarilo sa načítať market_code, používam SK.', error);
      }

      state.marketCode = 'SK';
    }

    async function loadCategories() {
      const { data, error } = await supa
        .from('categories')
        .select('id, name, slug, description, image_url')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .is('parent_id', null)
        .order('name')
        .limit(12);

      if (error) {
        throw error;
      }

      state.categories = data || [];
      state.categoryBySlug = new Map();
      state.categoryById = new Map();
      state.childrenByParent = new Map();

      state.categories.forEach((category) => {
        state.categoryBySlug.set(category.slug, category);
        state.categoryById.set(category.id, category);
      });

      if (!state.categories.length) {
        return;
      }

      const parentIds = state.categories.map((category) => category.id);
      const { data: children, error: childError } = await supa
        .from('categories')
        .select('id, name, slug, description, image_url, parent_id')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .in('parent_id', parentIds)
        .order('name');

      if (childError) {
        throw childError;
      }

      (children || []).forEach((child) => {
        state.categoryBySlug.set(child.slug, child);
        state.categoryById.set(child.id, child);
        const bucket = state.childrenByParent.get(child.parent_id) || [];
        bucket.push(child);
        state.childrenByParent.set(child.parent_id, bucket);
      });
    }

    async function ensureCategoryBySlug(slug) {
      if (!slug) {
        return null;
      }

      if (state.categoryBySlug.has(slug)) {
        return state.categoryBySlug.get(slug) || null;
      }

      const { data, error } = await supa
        .from('categories')
        .select('id, name, slug, description, image_url, parent_id')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .eq('slug', slug)
        .maybeSingle();

      if (error) {
        throw error;
      }

      if (!data) {
        return null;
      }

      state.categoryBySlug.set(data.slug, data);
      state.categoryById.set(data.id, data);

      if (data.parent_id) {
        const bucket = state.childrenByParent.get(data.parent_id) || [];
        if (!bucket.some((existing) => existing.id === data.id)) {
          bucket.push(data);
          state.childrenByParent.set(data.parent_id, bucket);
        }
      }

      return data;
    }

    async function ensureChildren(parentId) {
      if (!parentId) {
        return [];
      }

      if (state.childrenByParent.has(parentId)) {
        return state.childrenByParent.get(parentId) || [];
      }

      const { data, error } = await supa
        .from('categories')
        .select('id, name, slug, description, image_url, parent_id')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .eq('parent_id', parentId)
        .order('name');

      if (error) {
        throw error;
      }

      const rows = data || [];
      rows.forEach((child) => {
        state.categoryBySlug.set(child.slug, child);
        state.categoryById.set(child.id, child);
      });
      state.childrenByParent.set(parentId, rows);
      return rows;
    }

    async function hydrateCategoriesByIds(ids) {
      const missing = Array.from(
        new Set((ids || []).filter((id) => id && !state.categoryById.has(id)))
      );

      if (!missing.length) {
        return;
      }

      const { data, error } = await supa
        .from('categories')
        .select('id, name, slug, description, image_url, parent_id')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .in('id', missing);

      if (error) {
        throw error;
      }

      (data || []).forEach((category) => {
        state.categoryBySlug.set(category.slug, category);
        state.categoryById.set(category.id, category);
        if (category.parent_id) {
          const bucket = state.childrenByParent.get(category.parent_id) || [];
          if (!bucket.some((existing) => existing.id === category.id)) {
            bucket.push(category);
            state.childrenByParent.set(category.parent_id, bucket);
          }
        }
      });
    }

    async function collectDescendants(categoryId) {
      const stack = categoryId ? [categoryId] : [];
      const collected = new Set();

      while (stack.length) {
        const current = stack.pop();
        if (!current || collected.has(current)) {
          continue;
        }

        collected.add(current);
        const children = await ensureChildren(current);
        children.forEach((child) => stack.push(child.id));
      }

      return Array.from(collected);
    }

    function crumbs(parts) {
      if (!parts.length) {
        return '';
      }

      const links = [
        '<a href="?" onclick="event.preventDefault(); updateRoute({ c: null, shop: null, sort: null })">Domov</a>'
      ];

      const chain = [];
      parts.forEach((slug) => {
        chain.push(slug);
        const category = state.categoryBySlug.get(slug);
        if (!category) {
          return;
        }
        const href = `?c=${encodeURIComponent(buildSlugPath(chain))}`;
        links.push(`
          <a href="${href}" onclick="event.preventDefault(); updateRoute({ c: '${buildSlugPath(chain)}', shop: null, sort: null })">
            ${escapeHtml(category.name)}
          </a>
        `);
      });

      return `<div class="crumbs">${links.join(' › ')}</div>`;
    }

    function productCard(product) {
      const title = escapeHtml(product.title || 'Produkt');
      const price = formatPrice(product.price, product.currency);
      const merchant = escapeHtml(product.merchant || '');
      const categoryName = escapeHtml(product.categoryName || '');
      const image = escapeHtml(
        product.imageUrl || 'https://images.placeholders.dev/?width=320&height=240&text=Produkt'
      );
      const url = escapeHtml(product.link || '#');

      return `
        <a class="tile" href="${url}" target="_blank" rel="nofollow noopener">
          <div class="thumb"><img loading="lazy" src="${image}" alt="${title}" /></div>
          <h4>${title}</h4>
          <p class="price">${price}</p>
          <p class="muted">${categoryName}${merchant ? ` • ${merchant}` : ''}</p>
        </a>
      `;
    }

    function subcategoryCard(category, parentSlug) {
      const href = buildSlugPath([parentSlug, category.slug]);
      const image = escapeHtml(
        category.image_url || 'https://images.placeholders.dev/?width=320&height=240&text=Kategória'
      );
      return `
        <a class="tile" href="?c=${encodeURIComponent(href)}" onclick="event.preventDefault(); updateRoute({ c: '${href}', shop: null, sort: null })">
          <div class="thumb"><img loading="lazy" src="${image}" alt="${escapeHtml(category.name)}" /></div>
          <h3>${escapeHtml(category.name)}</h3>
          <p class="muted">${escapeHtml(category.description || '')}</p>
        </a>
      `;
    }

    async function fetchProducts(categoryId, { merchant = null, sort = 'price.asc' } = {}) {
      if (!categoryId) {
        return [];
      }

      const scope = await collectDescendants(categoryId);
      if (!scope.includes(categoryId)) {
        scope.push(categoryId);
      }

      let query = supa
        .from('products')
        .select('id, title, description, price, currency, image_url, availability, category_id, merchant_name, affiliate_url, product_url')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .in('category_id', scope)
        .limit(120);

      if (merchant) {
        query = query.eq('merchant_name', merchant);
      }

      const [column, direction] = sort.split('.');
      const ascending = direction !== 'desc';
      const columnName = column === 'title' ? 'title' : 'price';
      query = query.order(columnName, { ascending });

      const { data, error } = await query;
      if (error) {
        throw error;
      }

      await hydrateCategoriesByIds((data || []).map((item) => item.category_id));

      return (data || []).map((item) => {
        const category = state.categoryById.get(item.category_id);
        return {
          id: item.id,
          title: item.title,
          price: item.price,
          currency: item.currency,
          imageUrl: item.image_url,
          merchant: item.merchant_name || '',
          link: item.affiliate_url || item.product_url || '#',
          categoryName: category ? category.name : '',
        };
      });
    }

    async function renderHome() {
      searchInput.value = '';

      const heroPills = state.categories.slice(0, 6).map((category) => {
        const path = encodeURIComponent(category.slug);
        return `
          <a class="pill" href="?c=${path}" onclick="event.preventDefault(); updateRoute({ c: '${category.slug}', shop: null, sort: null })">
            ${escapeHtml(category.name)}
          </a>
        `;
      });

      const lanes = state.categories.slice(0, 6).map((category) => {
        const children = (state.childrenByParent.get(category.id) || []).slice(0, 6);
        const tiles = children.length
          ? children.map((child) => subcategoryCard(child, category.slug)).join('')
          : '<div class="center">Žiadne podkategórie.</div>';
        return `
          <section class="lane">
            <div class="lane-header">
              <h2>${escapeHtml(category.name)}</h2>
              <a class="pill" href="?c=${encodeURIComponent(category.slug)}" onclick="event.preventDefault(); updateRoute({ c: '${category.slug}', shop: null, sort: null })">Prejsť do kategórie</a>
            </div>
            <div class="lane-grid">${tiles}</div>
          </section>
        `;
      });

      app.innerHTML = `
        <section class="hero">
          <h1>Porovnávač cien tisícov produktov</h1>
          <p>Nájdite najlepšie ceny, tisíce produktov a stovky e-shopov na jednom mieste. Prekliknite sa do obľúbených kategórií a objavte aktuálne ponuky.</p>
          <div class="hero-ctas">
            <a class="cta primary" href="#" onclick="event.preventDefault(); document.getElementById('catalog-start').scrollIntoView({ behavior: 'smooth' });">Prejsť do katalógu</a>
            <a class="cta secondary" href="mailto:info@bestpric.eu">Chcem pridať e-shop</a>
          </div>
          <div class="hero-pills">
            ${heroPills.join('') || '<span>Pripravujeme kategórie…</span>'}
          </div>
        </section>
        <div id="catalog-start"></div>
        ${lanes.join('') || '<div class="center">Zatiaľ nemáme dostupné kategórie.</div>'}
      `;
    }

    async function renderCategory(slug) {
      const category = await ensureCategoryBySlug(slug);
      if (!category) {
        app.innerHTML = '<div class="center">Kategória sa nenašla.</div>';
        return;
      }

      searchInput.value = '';
      const children = await ensureChildren(category.id);
      const tiles = children.length
        ? children.map((child) => subcategoryCard(child, slug)).join('')
        : '<div class="center">Žiadne podkategórie.</div>';

      app.innerHTML = `
        ${crumbs([slug])}
        <section class="lane">
          <div class="lane-header">
            <div>
              <h2>${escapeHtml(category.name)}</h2>
              <p class="muted">${escapeHtml(category.description || '')}</p>
            </div>
          </div>
          <div class="lane-grid">${tiles}</div>
        </section>
      `;
    }

    async function renderLeaf(parts, options) {
      searchInput.value = '';

      const slugs = [...parts];
      for (const slug of slugs) {
        await ensureCategoryBySlug(slug);
      }

      const targetSlug = slugs[slugs.length - 1];
      const category = await ensureCategoryBySlug(targetSlug);
      if (!category) {
        app.innerHTML = '<div class="center">Kategória sa nenašla.</div>';
        return;
      }

      await ensureChildren(category.id);

      const normalizedOptions = {
        merchant: options.merchant ? String(options.merchant) : null,
        sort: options.sort || 'price.asc',
      };

      const products = await fetchProducts(category.id, normalizedOptions);
      const merchantNames = Array.from(
        new Set(products.map((product) => product.merchant).filter((name) => name && name.length))
      ).sort((a, b) => a.localeCompare(b));

      const shopOptions = [
        `<option value="" ${normalizedOptions.merchant ? '' : 'selected'}>Všetky obchody</option>`
      ];
      merchantNames.forEach((name) => {
        const escaped = escapeHtml(name);
        const selected = normalizedOptions.merchant === name ? 'selected' : '';
        shopOptions.push(`<option value="${escaped}" ${selected}>${escaped}</option>`);
      });

      const productGrid = products.length
        ? products.map((product) => productCard(product)).join('')
        : '<div class="center">Žiadne produkty pre túto kategóriu.</div>';

      app.innerHTML = `
        ${crumbs(parts)}
        <section class="lane">
          <div class="lane-header">
            <div>
              <h2>${escapeHtml(category.name)}</h2>
              <p class="muted">${escapeHtml(category.description || '')}</p>
            </div>
            <div class="muted">${products.length} produktov</div>
          </div>
          <div class="filters">
            <label>
              Obchod
              <select id="shop-filter">
                ${shopOptions.join('')}
              </select>
            </label>
            <label>
              Zoradiť
              <select id="sort-filter">
                <option value="price.asc" ${normalizedOptions.sort === 'price.asc' ? 'selected' : ''}>Najlacnejšie</option>
                <option value="price.desc" ${normalizedOptions.sort === 'price.desc' ? 'selected' : ''}>Najdrahšie</option>
                <option value="title.asc" ${normalizedOptions.sort === 'title.asc' ? 'selected' : ''}>A – Z</option>
                <option value="title.desc" ${normalizedOptions.sort === 'title.desc' ? 'selected' : ''}>Z – A</option>
              </select>
            </label>
          </div>
          <div class="lane-grid">${productGrid}</div>
        </section>
      `;

      const shopFilter = document.getElementById('shop-filter');
      const sortFilter = document.getElementById('sort-filter');

      shopFilter?.addEventListener('change', (event) => {
        const value = event.target.value;
        updateRoute({ shop: value || null });
      });

      sortFilter?.addEventListener('change', (event) => {
        updateRoute({ sort: event.target.value });
      });
    }

    async function renderSearch(term) {
      searchInput.value = term;

      const { data, error } = await supa
        .from('products')
        .select('id, title, price, currency, image_url, category_id, merchant_name, affiliate_url, product_url')
        .eq('market_code', state.marketCode)
        .eq('is_active', true)
        .ilike('title', `%${term}%`)
        .limit(120);

      if (error) {
        app.innerHTML = `<div class="center">Chyba: ${escapeHtml(error.message)}</div>`;
        return;
      }

      await hydrateCategoriesByIds((data || []).map((item) => item.category_id));

      const products = (data || []).map((item) => {
        const category = state.categoryById.get(item.category_id);
        return {
          id: item.id,
          title: item.title,
          price: item.price,
          currency: item.currency,
          imageUrl: item.image_url,
          merchant: item.merchant_name || '',
          link: item.affiliate_url || item.product_url || '#',
          categoryName: category ? category.name : '',
        };
      });

      const grid = products.length
        ? products.map((product) => productCard(product)).join('')
        : '<div class="center">Žiadne výsledky.</div>';

      app.innerHTML = `
        <section class="lane">
          <div class="lane-header">
            <h2>Hľadanie: “${escapeHtml(term)}”</h2>
            <div class="muted">${products.length} nájdených produktov</div>
          </div>
          <div class="lane-grid">${grid}</div>
        </section>
      `;
    }

    async function render() {
      if (!state.ready) {
        return;
      }

      const { slugPath, search, shop, sort } = parseRoute();
      const parts = slugParts(slugPath);

      try {
        if (search) {
          await renderSearch(search);
          return;
        }

        if (parts.length === 0) {
          await renderHome();
          return;
        }

        if (parts.length === 1) {
          await renderCategory(parts[0]);
          return;
        }

        await renderLeaf(parts, { merchant: shop || null, sort });
      } catch (error) {
        app.innerHTML = `<div class="center">Chyba: ${escapeHtml(error.message)}</div>`;
      }
    }

    async function boot() {
      app.innerHTML = '<div class="center">Načítavam katalóg…</div>';
      try {
        await detectMarket();
        await loadCategories();
        state.ready = true;
        await render();
        footerEl.textContent = `Aktualizované ${new Date().toLocaleString('sk-SK')}`;
      } catch (error) {
        app.innerHTML = `<div class="center">Chyba: ${escapeHtml(error.message)}</div>`;
      }
    }

    boot();
  </script>
</body>
</html>
