<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bestpric.eu</title>
  <meta name="description" content="Porovnávač cien tisícov produktov – nájdite najlepšie ponuky z desiatok obchodov na jednom mieste." />
  <link rel="icon" href="/favicon.ico">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --brand: #2563eb;
      --brand-soft: rgba(37, 99, 235, 0.12);
      --radius-lg: 28px;
      --radius-md: 18px;
      --gap: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font: 16px/1.5 "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.24);
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px var(--gap);
    }

    .brand {
      font-weight: 800;
      font-size: 24px;
      letter-spacing: -0.02em;
      color: var(--brand);
    }

    .search-bar {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .search-bar input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 999px;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    main {
      padding-bottom: 80px;
    }

    .hero {
      margin: 36px 0 28px;
      padding: 40px clamp(20px, 6vw, 48px);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(14, 116, 144, 0.08));
      color: var(--ink);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      display: grid;
      gap: 24px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(30px, 6vw, 44px);
      line-height: 1.08;
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      max-width: 620px;
      color: rgba(15, 23, 42, 0.78);
      font-size: 18px;
    }

    .hero-ctas {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 22px;
      border-radius: 999px;
      font-weight: 600;
      text-decoration: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .cta.primary {
      background: var(--brand);
      color: #fff;
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.3);
    }

    .cta.primary:hover {
      transform: translateY(-1px);
    }

    .cta.secondary {
      background: rgba(255, 255, 255, 0.85);
      color: var(--brand);
      border: 1px solid rgba(37, 99, 235, 0.25);
    }

    .hero-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--ink);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
    }

    .pill-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--brand-soft);
      color: var(--brand);
      font-size: 13px;
    }

    .lane {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
      margin-bottom: 28px;
    }

    .lane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px clamp(16px, 4vw, 28px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.16);
    }

    .lane-header h2 {
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.01em;
    }

    .lane-header-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .lane-grid {
      display: grid;
      gap: var(--gap);
      padding: clamp(16px, 4vw, 28px);
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .tile {
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148, 163, 184, 0.14);
      border-radius: var(--radius-md);
      background: var(--surface);
      text-decoration: none;
      color: inherit;
      overflow: hidden;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .tile:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
    }

    .thumb {
      aspect-ratio: 4 / 3;
      display: grid;
      place-items: center;
      background: rgba(37, 99, 235, 0.05);
    }

    .thumb img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .tile h3,
    .tile h4 {
      margin: 16px 18px 6px;
      font-size: 18px;
    }

    .muted {
      margin: 0 18px 18px;
      color: var(--muted);
      font-size: 14px;
    }

    .price {
      margin: 12px 18px 18px;
      font-weight: 700;
      font-size: 18px;
      color: var(--ink);
    }

    .crumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 18px;
    }

    .crumbs a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      padding: 0 clamp(16px, 4vw, 28px) 12px;
    }

    select {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: #fff;
      font: inherit;
    }

    .center {
      display: grid;
      place-items: center;
      padding: 48px;
      color: var(--muted);
      text-align: center;
    }

    footer {
      padding: 40px var(--gap);
      text-align: center;
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 720px) {
      .hero {
        padding: 32px 24px;
      }

      .lane-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
    }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="wrap search-bar">
      <div class="brand">bestpric.eu</div>
      <input id="search" type="search" placeholder="Hľadať produkty" autocomplete="off" />
    </div>
  </header>

  <main class="wrap" id="app"></main>

  <footer id="foot"></footer>

  <script>
    const SUPABASE_URL = 'https://xxplocdervsfftnnalah.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4cGxvY2RlcnZzZmZ0bm5hbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTIyODYsImV4cCI6MjA3MTQ2ODI4Nn0.Gh8AShwePYUuiJjj_G1qFuMaTRC_6HZOSERifIvjZro';
    const supa = supabase.createClient(SUPABASE_URL, ANON_KEY);

    const $ = (selector) => document.querySelector(selector);
    const app = $('#app');
    const searchInput = $('#search');
    const footerEl = $('#foot');

    const state = {
      ready: false,
      marketCode: 'SK',
      products: [],
      categoryByPath: new Map(),
      childrenByParent: new Map(),
      topLevelPaths: [],
    };

    function escapeHtml(value) {
      return (value || '').replace(/[&<>"']/g, (character) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[character] || character));
    }

    function formatPrice(value, currency) {
      if (value == null) {
        return '';
      }

      try {
        return new Intl.NumberFormat('sk-SK', {
          style: 'currency',
          currency: currency || 'EUR',
          minimumFractionDigits: 0,
        }).format(value);
      } catch (error) {
        return `${value} ${currency || 'EUR'}`;
      }
    }

    function slugify(value) {
      return (value || '')
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    }

    function uniqueSlug(base, used, fallback) {
      let candidate = base || fallback;
      let suffix = 1;
      while (used.has(candidate)) {
        suffix += 1;
        candidate = `${base || fallback}-${suffix}`;
      }
      used.add(candidate);
      return candidate;
    }

    function parseCategoryLabel(raw) {
      if (!raw) {
        return [];
      }

      if (Array.isArray(raw)) {
        return raw.map((value) => String(value).trim()).filter(Boolean);
      }

      const cleaned = String(raw).replace(/[>/]/g, '|');
      return cleaned
        .split('|')
        .map((part) => part.trim())
        .filter(Boolean);
    }

    function slugParts(path) {
      return (path || '')
        .split('|')
        .map((part) => part.trim())
        .filter(Boolean);
    }

    function buildSlugPath(parts) {
      return parts.filter(Boolean).join('|');
    }

    function updateRoute(params) {
      const url = new URL(window.location.href);
      Object.entries(params).forEach(([key, value]) => {
        if (value == null || value === '') {
          url.searchParams.delete(key);
        } else {
          url.searchParams.set(key, value);
        }
      });
      history.pushState({}, '', url);
      render();
    }

    window.addEventListener('popstate', render);

    searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const value = searchInput.value.trim();
        updateRoute({ search: value || null, c: null, shop: null, sort: null });
      }
    });

    function parseRoute() {
      const url = new URL(window.location.href);
      const slugPath = url.searchParams.get('c') || '';
      const search = url.searchParams.get('search') || '';
      const shop = url.searchParams.get('shop') || '';
      const sort = url.searchParams.get('sort') || 'price.asc';
      return { slugPath, search, shop, sort };
    }

    function getFirstAvailable(row, keys) {
      for (const key of keys) {
        if (row && row[key] != null && row[key] !== '') {
          return row[key];
        }
      }
      return null;
    }

    function getMarketCode(row) {
      const code = getFirstAvailable(row, ['market_code', 'marketCode', 'MarketCode']);
      return code ? String(code).toUpperCase() : null;
    }

    function normaliseProduct(row) {
      const rawCategory = getFirstAvailable(row, [
        'site_category',
        'category_path',
        'category',
        'category_text',
        'categoryText',
        'categoryName',
        'merchant_category',
        'merchantCategory',
      ]);

      const parts = parseCategoryLabel(rawCategory);
      const labels = parts.length ? parts : ['Produkty'];
      const used = new Set();
      const slugParts = labels.map((label, index) => {
        const base = slugify(label);
        return uniqueSlug(base, used, `segment-${index + 1}`);
      });
      const slugPath = slugParts.join('|');

      const rawPrice = row.price ?? row.current_price ?? row.sale_price;
      const numericPrice = typeof rawPrice === 'number' ? rawPrice : Number(rawPrice ?? NaN);
      const merchant = getFirstAvailable(row, ['shop_name', 'shopName', 'merchant_name', 'merchantName']);
      const currency = getFirstAvailable(row, ['currency', 'currency_code', 'currencyCode']) || 'EUR';
      const image = getFirstAvailable(row, ['image_url', 'imageUrl', 'image']);
      const link = getFirstAvailable(row, ['final_url', 'affiliate_url', 'product_url', 'url']);

      return {
        id: row.id,
        title: row.title || row.name || 'Produkt',
        price: Number.isFinite(numericPrice) ? numericPrice : null,
        currency,
        imageUrl: image || null,
        link: link || '#',
        merchant: merchant || '',
        categoryLabels: labels,
        slugParts,
        categoryPath: slugPath,
      };
    }

    function buildCatalog(products) {
      state.categoryByPath = new Map();
      state.childrenByParent = new Map();
      state.topLevelPaths = [];

      products.forEach((product) => {
        const { categoryLabels, slugParts, imageUrl } = product;
        let parentPath = null;
        slugParts.forEach((slug, index) => {
          const path = slugParts.slice(0, index + 1).join('|');
          const name = categoryLabels[index] || `Sekcia ${index + 1}`;
          let node = state.categoryByPath.get(path);
          if (!node) {
            node = {
              name,
              slug,
              slugPath: path,
              labelParts: categoryLabels.slice(0, index + 1),
              count: 0,
              image: imageUrl || null,
              parentPath,
            };
            state.categoryByPath.set(path, node);
            if (parentPath) {
              const children = state.childrenByParent.get(parentPath) || [];
              if (!children.includes(path)) {
                children.push(path);
                state.childrenByParent.set(parentPath, children);
              }
            } else if (!state.topLevelPaths.includes(path)) {
              state.topLevelPaths.push(path);
            }
          }

          node.count += 1;
          if (!node.image && imageUrl) {
            node.image = imageUrl;
          }
          parentPath = path;
        });
      });

      state.topLevelPaths.sort((a, b) => {
        const countA = state.categoryByPath.get(a)?.count || 0;
        const countB = state.categoryByPath.get(b)?.count || 0;
        return countB - countA;
      });
    }

    async function loadSnapshot(limit = 4000) {
      const { data, error } = await supa
        .from('site_products_v2')
        .select('*')
        .limit(limit);

      if (error) {
        throw error;
      }

      const rows = data || [];

      const marketCounts = new Map();
      rows.forEach((row) => {
        const code = getMarketCode(row);
        if (code) {
          marketCounts.set(code, (marketCounts.get(code) || 0) + 1);
        }
      });

      if (marketCounts.size) {
        state.marketCode = Array.from(marketCounts.entries()).sort((a, b) => b[1] - a[1])[0][0];
      }

      const filteredRows = rows.filter((row) => {
        const code = getMarketCode(row);
        return !code || !state.marketCode || code === state.marketCode;
      });

      state.products = filteredRows
        .map(normaliseProduct)
        .filter((product) => product && product.slugParts && product.slugParts.length);
      buildCatalog(state.products);
    }

    function crumbs(path) {
      if (!path) {
        return '';
      }

      const segments = path.split('|').filter(Boolean);
      if (!segments.length) {
        return '';
      }

      const links = [
        '<a href="?" onclick="event.preventDefault(); updateRoute({ c: null, shop: null, sort: null })">Domov</a>'
      ];

      let accumulator = '';
      segments.forEach((slug, index) => {
        accumulator = index === 0 ? slug : `${accumulator}|${slug}`;
        const node = state.categoryByPath.get(accumulator);
        if (!node) {
          return;
        }
        const href = `?c=${encodeURIComponent(accumulator)}`;
        links.push(`
          <a href="${href}" onclick="event.preventDefault(); updateRoute({ c: '${accumulator}', shop: null, sort: null })">
            ${escapeHtml(node.name)}
          </a>
        `);
      });

      return `<div class="crumbs">${links.join(' › ')}</div>`;
    }

    function productCard(product) {
      const title = escapeHtml(product.title);
      const price = formatPrice(product.price, product.currency);
      const merchant = escapeHtml(product.merchant || '');
      const category = escapeHtml(state.categoryByPath.get(product.categoryPath)?.name || '');
      const image = escapeHtml(product.imageUrl || 'https://images.placeholders.dev/?width=320&height=240&text=Produkt');
      const url = escapeHtml(product.link || '#');

      return `
        <a class="tile" href="${url}" target="_blank" rel="nofollow noopener">
          <div class="thumb"><img loading="lazy" src="${image}" alt="${title}" /></div>
          <h4>${title}</h4>
          <p class="price">${price}</p>
          <p class="muted">${category}${merchant ? ` • ${merchant}` : ''}</p>
        </a>
      `;
    }

    function subcategoryCard(node) {
      const image = escapeHtml(node.image || 'https://images.placeholders.dev/?width=320&height=240&text=Kategória');
      return `
        <a class="tile" href="?c=${encodeURIComponent(node.slugPath)}" onclick="event.preventDefault(); updateRoute({ c: '${node.slugPath}', shop: null, sort: null })">
          <div class="thumb"><img loading="lazy" src="${image}" alt="${escapeHtml(node.name)}" /></div>
          <h3>${escapeHtml(node.name)}</h3>
          <p class="muted">${node.count} produktov</p>
        </a>
      `;
    }

    function productsForPath(path) {
      if (!path) {
        return [];
      }
      const prefix = `${path}|`;
      return state.products.filter((product) =>
        product.categoryPath === path || product.categoryPath.startsWith(prefix)
      );
    }

    function sortProducts(products, sortKey) {
      const sorted = [...products];
      switch (sortKey) {
        case 'price.asc':
          sorted.sort((a, b) => (a.price ?? Infinity) - (b.price ?? Infinity));
          break;
        case 'price.desc':
          sorted.sort((a, b) => (b.price ?? Infinity) - (a.price ?? Infinity));
          break;
        case 'title.asc':
          sorted.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'title.desc':
          sorted.sort((a, b) => b.title.localeCompare(a.title));
          break;
        default:
          break;
      }
      return sorted;
    }

    function filterProducts(products, merchant) {
      if (!merchant) {
        return products;
      }
      return products.filter((product) => product.merchant === merchant);
    }

    function merchantsForProducts(products) {
      const names = new Set();
      products.forEach((product) => {
        if (product.merchant) {
          names.add(product.merchant);
        }
      });
      return Array.from(names).sort((a, b) => a.localeCompare(b));
    }

    function renderHome() {
      searchInput.value = '';

      const heroPills = state.topLevelPaths.slice(0, 6).map((path) => {
        const node = state.categoryByPath.get(path);
        if (!node) return '';
        return `
          <a class="pill" href="?c=${encodeURIComponent(path)}" onclick="event.preventDefault(); updateRoute({ c: '${path}', shop: null, sort: null })">
            ${escapeHtml(node.name)}
            <span class="pill-count">${node.count}</span>
          </a>
        `;
      });

      const lanes = state.topLevelPaths.slice(0, 6).map((path) => {
        const node = state.categoryByPath.get(path);
        if (!node) return '';
        const children = (state.childrenByParent.get(path) || [])
          .map((childPath) => state.categoryByPath.get(childPath))
          .filter(Boolean)
          .sort((a, b) => (b?.count ?? 0) - (a?.count ?? 0))
          .slice(0, 6);

        const tiles = children.length
          ? children.map((child) => subcategoryCard(child)).join('')
          : '<div class="center">Žiadne podkategórie.</div>';

        return `
          <section class="lane">
            <div class="lane-header">
              <div class="lane-header-info">
                <h2>${escapeHtml(node.name)}</h2>
                <span class="pill-count">${node.count}</span>
              </div>
              <a class="pill" href="?c=${encodeURIComponent(path)}" onclick="event.preventDefault(); updateRoute({ c: '${path}', shop: null, sort: null })">Prejsť do kategórie</a>
            </div>
            <div class="lane-grid">${tiles}</div>
          </section>
        `;
      });

      app.innerHTML = `
        <section class="hero">
          <h1>Porovnávač cien tisícov produktov</h1>
          <p>Nájdite najlepšie ceny, tisíce produktov a stovky e-shopov na jednom mieste. Prekliknite sa do obľúbených kategórií a objavte aktuálne ponuky.</p>
          <div class="hero-ctas">
            <a class="cta primary" href="#" onclick="event.preventDefault(); document.getElementById('catalog-start').scrollIntoView({ behavior: 'smooth' });">Prejsť do katalógu</a>
            <a class="cta secondary" href="mailto:info@bestpric.eu">Chcem pridať e-shop</a>
          </div>
          <div class="hero-pills">
            ${heroPills.join('') || '<span>Pripravujeme kategórie…</span>'}
          </div>
        </section>
        <div id="catalog-start"></div>
        ${lanes.join('') || '<div class="center">Zatiaľ nemáme dostupné kategórie.</div>'}
      `;
    }

    function renderCategory(path) {
      const node = state.categoryByPath.get(path);
      if (!node) {
        app.innerHTML = '<div class="center">Kategória sa nenašla.</div>';
        return;
      }

      searchInput.value = '';

      const children = (state.childrenByParent.get(path) || [])
        .map((childPath) => state.categoryByPath.get(childPath))
        .filter(Boolean)
        .sort((a, b) => (b?.count ?? 0) - (a?.count ?? 0));

      const tiles = children.length
        ? children.map((child) => subcategoryCard(child)).join('')
        : '<div class="center">Žiadne podkategórie.</div>';

      app.innerHTML = `
        ${crumbs(path)}
        <section class="lane">
          <div class="lane-header">
            <div class="lane-header-info">
              <h2>${escapeHtml(node.name)}</h2>
              <span class="pill-count">${node.count}</span>
            </div>
          </div>
          <div class="lane-grid">${tiles}</div>
        </section>
      `;
    }

    function renderLeaf(path, options) {
      const node = state.categoryByPath.get(path);
      if (!node) {
        app.innerHTML = '<div class="center">Kategória sa nenašla.</div>';
        return;
      }

      searchInput.value = '';

      const products = sortProducts(filterProducts(productsForPath(path), options.merchant), options.sort);
      const merchants = merchantsForProducts(products);

      const shopOptions = [
        `<option value="" ${options.merchant ? '' : 'selected'}>Všetky obchody</option>`
      ];
      merchants.forEach((name) => {
        const selected = options.merchant === name ? 'selected' : '';
        shopOptions.push(`<option value="${escapeHtml(name)}" ${selected}>${escapeHtml(name)}</option>`);
      });

      const productGrid = products.length
        ? products.map((product) => productCard(product)).join('')
        : '<div class="center">Žiadne produkty pre túto kategóriu.</div>';

      app.innerHTML = `
        ${crumbs(path)}
        <section class="lane">
          <div class="lane-header">
            <div class="lane-header-info">
              <h2>${escapeHtml(node.labelParts.join(' › '))}</h2>
              <span class="pill-count">${products.length}</span>
            </div>
          </div>
          <div class="filters">
            <label>
              Obchod
              <select id="shop-filter">
                ${shopOptions.join('')}
              </select>
            </label>
            <label>
              Zoradiť
              <select id="sort-filter">
                <option value="price.asc" ${options.sort === 'price.asc' ? 'selected' : ''}>Najlacnejšie</option>
                <option value="price.desc" ${options.sort === 'price.desc' ? 'selected' : ''}>Najdrahšie</option>
                <option value="title.asc" ${options.sort === 'title.asc' ? 'selected' : ''}>A – Z</option>
                <option value="title.desc" ${options.sort === 'title.desc' ? 'selected' : ''}>Z – A</option>
              </select>
            </label>
          </div>
          <div class="lane-grid">${productGrid}</div>
        </section>
      `;

      const shopFilter = document.getElementById('shop-filter');
      const sortFilter = document.getElementById('sort-filter');

      shopFilter?.addEventListener('change', (event) => {
        const value = event.target.value;
        updateRoute({ shop: value || null });
      });

      sortFilter?.addEventListener('change', (event) => {
        updateRoute({ sort: event.target.value });
      });
    }

    function renderSearch(term) {
      searchInput.value = term;

      const lowered = term.toLowerCase();
      const matches = state.products.filter((product) =>
        product.title.toLowerCase().includes(lowered)
      );

      const grid = matches.length
        ? matches.map((product) => productCard(product)).join('')
        : '<div class="center">Žiadne výsledky.</div>';

      app.innerHTML = `
        <section class="lane">
          <div class="lane-header">
            <div class="lane-header-info">
              <h2>Hľadanie: “${escapeHtml(term)}”</h2>
              <span class="pill-count">${matches.length}</span>
            </div>
          </div>
          <div class="lane-grid">${grid}</div>
        </section>
      `;
    }

    async function render() {
      if (!state.ready) {
        return;
      }

      const { slugPath, search, shop, sort } = parseRoute();
      const parts = slugParts(slugPath);

      try {
        if (search) {
          renderSearch(search);
          return;
        }

        if (parts.length === 0) {
          renderHome();
          return;
        }

        if (parts.length === 1) {
          renderCategory(parts[0]);
          return;
        }

        renderLeaf(buildSlugPath(parts), { merchant: shop || null, sort });
      } catch (error) {
        app.innerHTML = `<div class="center">Chyba: ${escapeHtml(error.message)}</div>`;
      }
    }

    async function boot() {
      app.innerHTML = '<div class="center">Načítavam katalóg…</div>';
      try {
        await loadSnapshot();
        state.ready = true;
        await render();
        footerEl.textContent = `Aktualizované ${new Date().toLocaleString('sk-SK')}`;
      } catch (error) {
        app.innerHTML = `<div class="center">Chyba: ${escapeHtml(error.message)}</div>`;
      }
    }

    boot();
  </script>
</body>
</html>
