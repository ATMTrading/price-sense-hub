<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>bestpric.eu</title>
<style>
  :root{
    --fg:#111;--muted:#60646c;--bg:#fff;--chip:#fff;--chipb:#e5e7eb;--card:#fafafa;--brand:#0d9488;
    --border:#e5e7eb;--shadow:0 1px 2px rgba(0,0,0,.05),0 4px 12px rgba(0,0,0,.04)
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  .wrap{max-width:1180px;margin:20px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
  h1{margin:0;font-size:20px}
  #q{flex:1;min-width:240px;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
  select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .btn{padding:10px 16px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  #err{color:#b00020;margin:8px 0;display:none;white-space:pre-wrap}

  /* Tiles (category wall) */
  #tiles{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px;margin:10px 0}
  .tile{display:block;border:1px solid var(--border);background:#fff;border-radius:14px;box-shadow:var(--shadow);
        text-decoration:none;color:inherit;overflow:hidden}
  .tile .thumb{aspect-ratio:5/3;background:#f6f7f8;display:flex;align-items:center;justify-content:center}
  .tile .thumb img{max-width:100%;max-height:100%;object-fit:contain}
  .tile .meta{padding:10px 12px}
  .tile .title{font-weight:700}
  .tile .count{color:var(--muted);font-size:12px;margin-top:4px}

  /* Grid (products) */
  #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
  .card{border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:var(--shadow);
        text-decoration:none;color:inherit;display:block;overflow:hidden}
  .img{aspect-ratio:1/1;background:#f7f7f7;display:flex;align-items:center;justify-content:center}
  .img img{max-width:100%;max-height:100%;object-fit:contain}
  .pad{padding:10px 12px}
  .title{font-size:14px;line-height:1.3;height:3.4em;overflow:hidden}
  .price{margin-top:6px;font-weight:800}
  .cat{font-size:12px;color:var(--muted);margin-top:2px}
  .breadcrumbs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .crumb{color:var(--brand);cursor:pointer}
  #empty{display:none;color:var(--muted);text-align:center;margin:24px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>bestpric.eu</h1>
    <input id="q" placeholder="Search products‚Ä¶" />
  </header>

  <div id="err"></div>

  <!-- Tile wall -->
  <div id="tiles"></div>

  <!-- Category / listing mode -->
  <div id="categoryArea" style="display:none">
    <div class="breadcrumbs">
      <span class="crumb" id="crumbHome">üè† Domov</span>
      <span>‚Ä∫</span>
      <span id="crumbCat"></span>
    </div>

    <div class="toolbar">
      <select id="brand">
        <option value="">V≈°etky obchody</option>
      </select>
      <select id="sort">
        <option value="price.asc">Najlacnej≈°ie</option>
        <option value="price.desc">Najdrah≈°ie</option>
      </select>
    </div>

    <div id="grid"></div>
    <div id="empty">≈Ωiadne produkty.</div>
    <button id="more" class="btn">Naƒç√≠ta≈• viac</button>
  </div>
</div>

<script>
/* ================= Supabase config (kept exactly) ================= */
const SUPABASE_URL = 'https://xxplocdervsfftnnalah.supabase.co';
const ANON_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4cGxvY2RlcnZzZmZ0bm5hbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTIyODYsImV4cCI6MjA3MTQ2ODI4Nn0.Gh8AShwePYUuiJjj_G1qFuMaTRC_6HZOSERifIvjZro';
const baseHeaders  = { apikey: ANON_KEY, Authorization: 'Bearer ' + ANON_KEY };

/* ================= State ================= */
const state = {
  mode: 'tiles',            // 'tiles' | 'list' | 'search'
  // for listing:
  categoryLabel: '',        // raw label for UI (breadcrumbs)
  categoryTerm: '',         // right-most segment used for filtering
  brand: '',
  sort: 'price.asc',
  q: '',
  limit: 24,
  offset: 0
};

const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const showErr = (m='')=>{ const el=$('#err'); el.textContent=m; el.style.display=m?'block':'none' };
const fmtPrice=(n)=>Number.isFinite(+n)?`${(+n).toFixed(2)} ‚Ç¨`:'';

/* ================= Small fetch helper ================= */
async function fetchJSON(url, opts={}) {
  const res = await fetch(url, { ...opts, headers: { ...baseHeaders, ...(opts.headers||{}) } });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* ================= Helpers ================= */
const splitSegments = (label='') => label.split('|').map(s=>s.trim()).filter(Boolean);
const rightMostTerm = (label='') => {
  const segs = splitSegments(label);
  return (segs.pop() || label).trim();
};
const topLevel = (label='') => {
  const segs = splitSegments(label);
  return (segs[0] || label).trim();
};

/* ================= Affiliate helpers ================= */
function parseQueryString(qs){
  const out=[]; if(!qs) return out; const s=qs.replace(/^\?/,'');

  for(const part of s.split('&')){ if(!part) continue; const [k,v='']=part.split('=',2); if(!k) continue; out.push([decodeURIComponent(k), decodeURIComponent(v)]) }
  return out;
}
function appendSuffix(rawUrl, suffix){
  if(!rawUrl) return '#';
  let u; try{ u=new URL(rawUrl) }catch{ return rawUrl }
  if(suffix && typeof suffix==='string'){
    for(const [k,v] of parseQueryString(suffix)) u.searchParams.set(k,v);
  }
  return u.toString();
}
function pickBestUrl(p){
  // Prefer final_url if you have it; otherwise fall back to product_url
  if(p.final_url) return p.final_url;
  if(p.product_url) return p.product_url;
  return '#';
}
function affiliateLink(p){
  const base   = pickBestUrl(p);
  const suffix = p.affiliate_suffix || '';
  return appendSuffix(base, suffix);
}

/* ================= 1) Category tiles ================= */
async function loadTiles(){
  try{
    const url = `${SUPABASE_URL}/rest/v1/mv_category_summaries?select=*`;
    const rows = await fetchJSON(url);

    // Group by FIRST segment (top-level) and aggregate counts + sample image
    const groups = new Map();
    for(const r of rows){
      const label = r.label || r.name || '';
      const first = topLevel(label);
      const n = Number(r.n_products ?? r.total ?? r.product_count ?? 0) || 0;
      const img = r.image_url || r.thumb || r.sample_image || '';
      const g = groups.get(first) || { label:first, n:0, img:'' };
      g.n += n;
      if(!g.img && img) g.img = img;
      groups.set(first, g);
    }

    // Take top 12 by count, then sort alphabetically for nice layout
    const list = Array.from(groups.values())
      .sort((a,b)=>b.n-a.n)
      .slice(0,12)
      .sort((a,b)=>a.label.localeCompare(b.label,'sk',{sensitivity:'base'}));

    $('#tiles').innerHTML = list.map(r=>`
      <a class="tile" data-label="${encodeURIComponent(r.label)}" href="#">
        <div class="thumb">${r.img?`<img src="${r.img}" alt="">`:''}</div>
        <div class="meta">
          <div class="title">${r.label||'‚Äî'}</div>
          <div class="count">${r.n?`${r.n} produktov`:''}</div>
        </div>
      </a>
    `).join('');

    $('#tiles').addEventListener('click', (ev)=>{
      const a = ev.target.closest('.tile');
      if(!a) return;
      ev.preventDefault();
      const label = decodeURIComponent(a.dataset.label||'');
      enterCategory(label);
    });
  }catch(e){
    showErr('Cannot load tiles: ' + e.message);
  }
}

/* ================= 2) Listing (category/search) ================= */
function buildProductsUrl({categoryTerm, brand, sort, q, limit, offset}){
  const fields = [
    'id','title','price','currency','image_url',
    'final_url','product_url',
    'merchant_category','site_category','shop_name','affiliate_suffix'
  ].join(',');

  const params = new URLSearchParams({ select: fields, limit, offset, order: sort });

  // Use ILIKE on both merchant_category & site_category with the RIGHT-MOST segment
  if(categoryTerm){
    const enc = encodeURIComponent(categoryTerm);
    // or=(merchant_category.ilike.*term*,site_category.ilike.*term*)
    params.append('or', `(merchant_category.ilike.*${enc}*,site_category.ilike.*${enc}*)`);
  }
  if(brand) params.append('shop_name', `eq.${brand}`);
  if(q)     params.append('title', `ilike.*${q}*`);

  return `${SUPABASE_URL}/rest/v1/site_products_live?${params.toString()}`;
}

function renderProducts(rows,{replace=false}={}){
  const grid = $('#grid');
  const html = rows.map(p=>`
    <a class="card" href="${affiliateLink(p)}" target="_blank" rel="nofollow noopener">
      <div class="img"><img src="${p.image_url||''}" alt=""></div>
      <div class="pad">
        <div class="title">${p.title||''}</div>
        <div class="price">${fmtPrice(p.price)}</div>
        <div class="cat">${(p.merchant_category||p.site_category||'')}${p.shop_name?' ‚Ä¢ '+p.shop_name:''}</div>
      </div>
    </a>
  `).join('');
  if(replace) grid.innerHTML = html;
  else grid.insertAdjacentHTML('beforeend', html);
  $('#empty').style.display = grid.children.length ? 'none' : 'block';
}

async function loadBrandsFor(categoryTerm){
  try{
    const enc = encodeURIComponent(categoryTerm);
    const url  = `${SUPABASE_URL}/rest/v1/site_products_live?select=shop_name&or=(merchant_category.ilike.*${enc}*,site_category.ilike.*${enc}*)&shop_name=not.is.null`;
    const rows = await fetchJSON(url);
    const names = [...new Set(rows.map(r=>r.shop_name).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'sk'));
    $('#brand').innerHTML = `<option value="">V≈°etky obchody</option>` + names.map(n=>`<option>${n}</option>`).join('');
  }catch(e){
    console.warn('Brand load failed', e);
    $('#brand').innerHTML = `<option value="">V≈°etky obchody</option>`;
  }
}

async function loadProducts({append=false, replace=false}={}){
  try{
    showErr('');
    const url  = buildProductsUrl({
      categoryTerm: state.mode==='list' ? state.categoryTerm : '',
      brand:        state.mode==='list' ? state.brand        : '',
      sort:         state.sort,
      q:            state.mode==='search' ? state.q : '',
      limit:        state.limit,
      offset:       state.offset
    });
    const rows = await fetchJSON(url);
    renderProducts(rows,{replace});
    $('#more').style.display = rows.length < state.limit ? 'none' : 'inline-block';
    return rows;
  }catch(e){
    showErr('Cannot load products: ' + e.message);
    return [];
  }
}

/* ================= Navigation / mode switches ================= */
function showTiles(){
  state.mode='tiles';
  $('#tiles').style.display='grid';
  $('#categoryArea').style.display='none';
}

async function enterCategory(label){
  state.mode='list';
  state.categoryLabel = label;
  state.categoryTerm  = rightMostTerm(label);    // critical fix
  state.brand=''; state.sort='price.asc';
  state.q=''; state.offset=0;
  $('#crumbCat').textContent = label;
  $('#q').value='';
  $('#tiles').style.display='none';
  $('#categoryArea').style.display='block';
  await loadBrandsFor(state.categoryTerm);
  await loadProducts({replace:true});
}

$('#crumbHome').addEventListener('click',()=>{ showTiles() });

/* ================= Controls ================= */
$('#brand').addEventListener('change', async (e)=>{
  state.brand = e.target.value;
  state.offset=0;
  await loadProducts({replace:true});
});
$('#sort').addEventListener('change', async (e)=>{
  state.sort = e.target.value;
  state.offset=0;
  await loadProducts({replace:true});
});

$('#more').addEventListener('click', async ()=>{
  state.offset += state.limit;
  const rows = await loadProducts({append:true});
  if(!rows.length) state.offset -= state.limit;
});

/* Search (global) */
$('#q').addEventListener('input', async (e)=>{
  const v = e.target.value.trim();
  if(!v){
    if(state.mode==='search') showTiles();
    return;
  }
  state.mode='search';
  state.q=v; state.offset=0;
  $('#tiles').style.display='none';
  $('#categoryArea').style.display='block';
  $('#brand').innerHTML = `<option value="">V≈°etky obchody</option>`;
  $('#crumbCat').textContent = `Hƒæadanie: "${v}"`;
  await loadProducts({replace:true});
});

/* ================= Boot ================= */
(async function init(){
  try{
    showErr('');
    await loadTiles();
    showTiles(); // start on tiles
  }catch(e){
    showErr(e.message||String(e));
  }
})();
</script>
</body>
</html>
