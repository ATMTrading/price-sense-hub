<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bestpric.eu</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{--gap:16px;--card:12px;--muted:#6b7280;--bg:#fafafa;--ink:#0f172a;--brand:#16a34a}
    *{box-sizing:border-box} body{margin:0;font:16px/1.45 system-ui,Segoe UI,Roboto,Inter,sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
    .wrap{max-width:1200px;margin:0 auto;padding:12px var(--gap)}
    .brand{font-weight:800;font-size:22px;margin-right:14px}
    .search{display:flex;gap:10px;align-items:center}
    .search input{flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
    .crumbs{font-size:14px;color:var(--muted);display:flex;gap:6px;align-items:center;margin:10px 0}
    .lane{background:#fff;border:1px solid #eee;border-radius:14px;margin:var(--gap) 0}
    .lane-hd{display:flex;justify-content:space-between;align-items:center;padding:12px var(--gap);border-bottom:1px solid #f1f5f9}
    .lane-hd h2{margin:0;font-size:20px}
    .lane-grid{display:grid;gap:var(--gap);padding:var(--gap);grid-template-columns:repeat(4,1fr)}
    .tile{background:#fff;border:1px solid #eee;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;display:grid;place-items:center;background:#f6f7f8}
    .thumb img{max-width:100%;max-height:100%;object-fit:contain}
    .tile h3,.tile h4{margin:10px 12px 6px 12px;font-size:16px}
    .muted{color:var(--muted);font-size:13px;margin:0 12px 12px 12px}
    .price{font-weight:700;margin:0 12px 12px 12px}
    .btn-link{color:#2563eb;text-decoration:none;font-weight:600}
    .filters{display:flex;gap:10px;align-items:center;padding:0 var(--gap) var(--gap)}
    select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .center{display:grid;place-items:center;padding:40px;color:var(--muted)}
    @media (max-width: 960px){ .lane-grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 560px){ .lane-grid{grid-template-columns:1fr} }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="wrap search">
    <div class="brand">bestpric.eu</div>
    <input id="q" type="search" placeholder="Search products‚Ä¶" />
  </div>
</header>

<main class="wrap" id="app"></main>

<script>
/* ------------------- CONFIG ------------------- */
const SUPABASE_URL = "https://xxplocdervsfftnnalah.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4cGxvY2RlcnZzZmZ0bm5hbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTIyODYsImV4cCI6MjA3MTQ2ODI4Nn0.Gh8AShwePYUuiJjj_G1qFuMaTRC_6HZOSERifIvjZro";
const supa = supabase.createClient(SUPABASE_URL, ANON_KEY);
  
/* Helpers */
const $ = sel => document.querySelector(sel);
const app = $("#app");

function fmtPrice(price, currency){
  if (price == null) return "";
  return new Intl.NumberFormat('sk-SK', {style:'currency', currency: currency || 'EUR'}).format(price);
}

function slugParts(label){
  // labels look like "Dom a z√°hrada | B√Ωvanie a doplnky | Domov√© alarmy"
  return (label || "").split("|").map(s => s.trim()).filter(Boolean);
}

function linkToCategory(parts){
  // parts array -> ?c=Dom%20a%20z√°hrada|B√Ωvanie%20a%20doplnky or include third for leaf
  return `?c=${encodeURIComponent(parts.join(" | "))}`;
}

function getRoute(){
  const url = new URL(location.href);
  const search = url.searchParams.get("search") || "";
  const cParam = url.searchParams.get("c");
  const parts = cParam ? cParam.split("|").map(s=>s.trim()).filter(Boolean) : [];
  return {search, parts};
}

function setRoute(params){
  const url = new URL(location.href);
  Object.entries(params).forEach(([k,v])=>{
    if (v == null || v==="") url.searchParams.delete(k);
    else url.searchParams.set(k,v);
  });
  history.pushState({}, "", url);
  render();
}

window.addEventListener("popstate", render);
$("#q").addEventListener("keydown", e => {
  if (e.key === "Enter"){
    const val = $("#q").value.trim();
    setRoute({search: val || null, c: null});
  }
});

/* ------------------- DATA ------------------- */

// Home sections (main categories) from mv_category_summaries
async function fetchHomeSections(limitCats=8, itemsPerCat=5){
  // get most populated first-level categories
  const { data, error } = await supa
    .from("mv_category_summaries")
    .select("label, item_count, sample_image")
    .order("item_count", {ascending:false})
    .limit(400); // enough to group

  if (error) throw error;

  // Group by first-level
  const groups = new Map();
  for (const row of data){
    const parts = slugParts(row.label);
    if (parts.length < 1) continue;
    const k = parts[0];
    const prev = groups.get(k) || { label:k, total:0, children:[] };
    prev.total += (row.item_count || 0);
    prev.children.push(row);
    groups.set(k, prev);
  }

  // Rank by total size, keep top N
  const ranked = [...groups.values()]
    .sort((a,b)=> b.total - a.total)
    .slice(0, limitCats);

  // For each main category, pick a few representative leaf summaries (deeper ones)
  // We prioritize leaf rows (length >= 2) with highest counts
  const lanes = [];
  for (const g of ranked){
    const leaves = g.children
      .filter(r => slugParts(r.label).length >= 2)
      .sort((a,b)=> (b.item_count||0)-(a.item_count||0))
      .slice(0, itemsPerCat);

    lanes.push({ main:g.label, items: leaves });
  }
  return lanes;
}

// Subcategories for a first-level category
async function fetchSubcategories(level1){
  // Filter rows whose label starts with `${level1} |`
  const { data, error } = await supa
    .from("mv_category_summaries")
    .select("label, item_count, sample_image")
    .ilike("label", `${level1} |%`);
  if (error) throw error;

  // Keep 2nd level
  const map = new Map();
  for (const row of data){
    const parts = slugParts(row.label);
    if (parts.length < 2) continue;
    const key = parts[0] + " | " + parts[1];
    const prev = map.get(key) || { label:key, item_count:0, sample_image:row.sample_image };
    prev.item_count += (row.item_count || 0);
    map.set(key, prev);
  }
  return [...map.values()].sort((a,b)=> (b.item_count||0)-(a.item_count||0));
}

// Products for a leaf (level1 | level2 | optional level3)
async function fetchProductsForCategory(label, page=1, pageSize=24, shop=null, sort="price.asc"){
  // We‚Äôll filter products by matching the last segment against both merchant_category & site_category
  // This is robust across mixed feeds.
  const parts = slugParts(label);
  const needle = parts[parts.length-1];

  // Columns to return
  let query = supa
    .from("site_products_live")
    .select("id,title,price,currency,image_url,final_url,shop_name,merchant_category,site_category", {count:"exact"})
    .or(`merchant_category.ilike.%${needle}%,site_category.ilike.%${needle}%`);

  if (shop && shop !== "all") query = query.eq("shop_name", shop);

  // Sorting
  let [col, dir] = sort.split(".");
  if (!col) col = "price";
  if (!dir) dir = "asc";
  query = query.order(col, {ascending: dir==="asc"});

  // Paging
  const from = (page-1)*pageSize;
  const to = from + pageSize - 1;
  query = query.range(from, to);

  const { data, error, count } = await query;
  if (error) throw error;
  return {items:data||[], total: count||0};
}

// Shops for filter (optional)
async function fetchShops(){
  // derive from products to keep it simple
  const { data, error } = await supa
    .from("site_products_live")
    .select("shop_name")
    .not("shop_name","is",null)
    .limit(10000);
  if (error) throw error;
  const set = new Set((data||[]).map(d=>d.shop_name).filter(Boolean));
  return ["all", ...[...set].sort()];
}

/* ------------------- RENDER ------------------- */

function crumbs(parts){
  if (!parts.length) return "";
  const nodes = [];
  nodes.push(`<a class="btn-link" href="?" onclick="event.preventDefault(); setRoute({c:null})">Domov</a>`);
  if (parts[0]) nodes.push(`<a class="btn-link" href="${linkToCategory([parts[0]])}" onclick="event.preventDefault(); setRoute({c:'${parts[0]}'})">${parts[0]}</a>`);
  if (parts[1]) nodes.push(`<span>${parts[1]}</span>`);
  if (parts[2]) nodes.push(`<span>${parts[2]}</span>`);
  return `<div class="crumbs">üè† ${nodes.join(" ‚Ä∫ ")}</div>`;
}

function productCard(p){
  return `
  <a class="tile" href="${p.final_url}" target="_blank" rel="nofollow noopener">
    <div class="thumb"><img loading="lazy" src="${p.image_url || ""}" alt=""></div>
    <h4>${p.title || ""}</h4>
    <div class="price">${fmtPrice(p.price, p.currency)}</div>
    <p class="muted">${p.site_category || p.merchant_category || ""} ‚Ä¢ ${p.shop_name || ""}</p>
  </a>`;
}

function subcatCard(label, count, img){
  const parts = slugParts(label);
  const href = linkToCategory([parts[0], parts[1]]);
  return `
    <a class="tile" href="${href}" onclick="event.preventDefault(); setRoute({c:'${parts[0]} | ${parts[1]}'})">
      <div class="thumb"><img loading="lazy" src="${img || ""}" alt=""></div>
      <h3>${parts[1]}</h3>
      <p class="muted">${count} produktov</p>
    </a>`;
}

function homeLane(lane){
  // lane.main is the main category, lane.items are representative leaves
  const mainHref = linkToCategory([lane.main]);
  const tiles = lane.items.map(it => {
    const parts = slugParts(it.label);
    // Link to that subcategory list (level-2 if exists, else level-1 leaf)
    const linkParts = parts.slice(0, Math.min(2, parts.length));
    const href = linkToCategory(linkParts);
    const subtitle = parts.slice(1).join(" ‚Ä∫ ");
    return `
      <a class="tile" href="${href}" onclick="event.preventDefault(); setRoute({c:'${linkParts.join(" | ")}'})">
        <div class="thumb"><img loading="lazy" src="${it.sample_image || ""}" alt=""></div>
        <h4>${subtitle || lane.main}</h4>
        <p class="muted">${it.item_count} produktov</p>
      </a>`;
  }).join("");

  return `
  <section class="lane">
    <div class="lane-hd">
      <h2>${lane.main}</h2>
      <a class="btn-link" href="${mainHref}" onclick="event.preventDefault(); setRoute({c:'${lane.main}'})">Zobrazi≈• viac ‚Üí</a>
    </div>
    <div class="lane-grid">${tiles}</div>
  </section>`;
}

/* Views */

async function viewHome(){
  $("#q").value = "";
  app.innerHTML = `<div class="lane"><div class="lane-hd"><h2>Naƒç√≠tavam‚Ä¶</h2></div></div>`;
  try{
    const lanes = await fetchHomeSections(8, 5);
    app.innerHTML = lanes.map(homeLane).join("");
  }catch(e){
    app.innerHTML = `<div class="center">Chyba: ${e.message}</div>`;
  }
}

async function viewCategory(level1){
  $("#q").value = "";
  app.innerHTML = `${crumbs([level1])}
  <section class="lane">
    <div class="lane-hd"><h2>${level1}</h2></div>
    <div class="lane-grid" id="subgrid"></div>
  </section>`;
  try{
    const subs = await fetchSubcategories(level1);
    const html = subs.map(s => subcatCard(s.label, s.item_count, s.sample_image)).join("");
    $("#subgrid").innerHTML = html || `<div class="center">≈Ωiadne podkateg√≥rie.</div>`;
  }catch(e){
    $("#subgrid").innerHTML = `<div class="center">Chyba: ${e.message}</div>`;
  }
}

async function viewLeaf(label){
  const parts = slugParts(label);
  $("#q").value = "";

  // filters
  const shops = await fetchShops();

  // read filter state from URL
  const url = new URL(location.href);
  const shop = url.searchParams.get("shop") || "all";
  const sort = url.searchParams.get("sort") || "price.asc";
  const page = parseInt(url.searchParams.get("page") || "1", 10);

  app.innerHTML = `
    ${crumbs(parts)}
    <div class="lane">
      <div class="lane-hd"><h2>${parts.join(" ‚Ä∫ ")}</h2></div>
      <div class="filters">
        <label>Obchody
          <select id="shop">
            ${shops.map(s => `<option value="${s}" ${s===shop?'selected':''}>${s==='all'?'V≈°etky obchody':s}</option>`).join("")}
          </select>
        </label>
        <label>Zoradi≈•
          <select id="sort">
            <option value="price.asc"  ${sort==='price.asc'?'selected':''}>Najlacnej≈°ie</option>
            <option value="price.desc" ${sort==='price.desc'?'selected':''}>Najdrah≈°ie</option>
          </select>
        </label>
      </div>
      <div class="lane-grid" id="grid"></div>
      <div class="center" id="pager"></div>
    </div>`;

  $("#shop").addEventListener("change", e => {
    const v = e.target.value;
    setRoute({shop: v==='all'?null:v, sort, page:null}); // reset page
  });
  $("#sort").addEventListener("change", e => {
    const v = e.target.value;
    setRoute({sort: v, page:null});
  });

  try{
    const {items, total} = await fetchProductsForCategory(label, page, 24, shop, sort);
    $("#grid").innerHTML = items.map(productCard).join("") || `<div class="center">≈Ωiadne produkty.</div>`;

    // pager
    if (total > 24){
      const last = Math.ceil(total / 24);
      const prev = page > 1 ? `<a class="btn-link" href="#" onclick="event.preventDefault(); setRoute({page:${page-1}})">‚Äπ Predch√°dzaj√∫ca</a>` : "";
      const next = page < last ? `<a class="btn-link" href="#" onclick="event.preventDefault(); setRoute({page:${page+1}})">ƒéal≈°ia ‚Ä∫</a>` : "";
      $("#pager").innerHTML = `${prev} &nbsp; Strana ${page}/${last} &nbsp; ${next}`;
    }else{
      $("#pager").innerHTML = "";
    }
  }catch(e){
    $("#grid").innerHTML = `<div class="center">Chyba: ${e.message}</div>`;
  }
}

async function viewSearch(term){
  $("#q").value = term;
  // simple search against title
  app.innerHTML = `
    <div class="lane">
      <div class="lane-hd"><h2>Hƒæadanie: ‚Äú${term}‚Äù</h2></div>
      <div class="lane-grid" id="grid"></div>
    </div>`;
  try{
    const { data, error } = await supa
      .from("site_products_live")
      .select("id,title,price,currency,image_url,final_url,shop_name,merchant_category,site_category")
      .ilike("title", `%${term}%`)
      .limit(96);
    if (error) throw error;
    $("#grid").innerHTML = (data||[]).map(productCard).join("") || `<div class="center">≈Ωiadne produkty.</div>`;
  }catch(e){
    $("#grid").innerHTML = `<div class="center">Chyba: ${e.message}</div>`;
  }
}

async function render(){
  const {search, parts} = getRoute();

  // Route map:
  // no search & no parts -> home
  // parts = [L1]        -> subcategory tiles
  // parts = [L1,L2...]  -> leaf products
  // search only         -> search results
  try{
    if (search){
      await viewSearch(search);
      return;
    }
    if (parts.length === 0){
      await viewHome();
      return;
    }
    if (parts.length === 1){
      await viewCategory(parts[0]);
      return;
    }
    await viewLeaf(parts.join(" | "));
  }catch(e){
    app.innerHTML = `<div class="center">Chyba: ${e.message}</div>`;
  }
}

render();
</script>
</body>
</html>
